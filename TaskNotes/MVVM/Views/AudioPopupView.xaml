<?xml version="1.0" encoding="utf-8" ?>

<!-- ===================================================== -->
<!-- POPUP DE DICTADO POR VOZ -->
<!-- Implementado con CommunityToolkit.Maui Popup -->
<!-- DataBinding directo al TaskGestorViewModel -->
<!-- ===================================================== -->
<toolkit:Popup
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:TaskNotes.MVVM.ViewModels"
    x:Class="TaskNotes.MVVM.Views.AudioPopupView"
    x:DataType="vm:TaskGestorViewModel">

    <!-- ===================================================== -->
    <!-- CONTENEDOR PRINCIPAL DEL POPUP -->
    <!-- Border actÃºa como tarjeta/modal -->
    <!-- ===================================================== -->
    <Border StrokeShape="RoundRectangle 24"
            StrokeThickness="0"
            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
            Padding="24"
            WidthRequest="360"
            HorizontalOptions="Center"
            VerticalOptions="Center">

        <!-- Sombra para dar sensaciÃ³n de elevaciÃ³n -->
        <Border.Shadow>
            <Shadow Brush="Black"
                    Offset="0,10"
                    Radius="20"
                    Opacity="0.2" />
        </Border.Shadow>

        <!-- ===================================================== -->
        <!-- LAYOUT PRINCIPAL -->
        <!-- Organiza todo el contenido verticalmente -->
        <!-- ===================================================== -->
        <VerticalStackLayout Spacing="16">

            <!-- ================================================= -->
            <!-- CABECERA -->
            <!-- Icono + tÃ­tulo + estado de escucha -->
            <!-- ================================================= -->
            <VerticalStackLayout Spacing="8"
                                 HorizontalOptions="Center">

                <!-- Icono representativo del dictado por voz -->
                <Label Text="ðŸŽ™ï¸"
                       FontSize="40"
                       HorizontalOptions="Center" />

                <!-- TÃ­tulo del popup -->
                <!-- Usa un color fijo (TextPrimaryDark), no dependiente del tema -->
                <Label Text="Dictado por Voz"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="{StaticResource TextPrimaryDark}"
                       HorizontalOptions="Center"/>

                <!-- Indicador visual de estado activo -->
                <!-- Visible solo cuando el micrÃ³fono estÃ¡ escuchando -->
                <!-- El color Error se usa como alerta visual, no como error funcional -->
                <Label Text="Escuchando..."
                       FontSize="12"
                       TextColor="{StaticResource Error}"
                       IsVisible="{Binding IsListening}"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>

            <!-- ================================================= -->
            <!-- ÃREA DE TEXTO DICTADO -->
            <!-- Muestra en tiempo real el texto reconocido -->
            <!-- ================================================= -->
            <Border BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#2C2C2C}"
                    StrokeThickness="0"
                    StrokeShape="RoundRectangle 12"
                    Padding="12">

                <!-- ScrollView evita que el popup crezca -->
                <!-- cuando el texto dictado aumenta -->
                <ScrollView HeightRequest="100">

                    <!-- Texto enlazado al ViewModel -->
                    <!-- Se actualiza conforme avanza el dictado -->
                    <Label Text="{Binding NewTaskTitle}"
                           FontSize="16"
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                           HorizontalTextAlignment="Center"
                           VerticalOptions="Center" />
                </ScrollView>
            </Border>

            <!-- ================================================= -->
            <!-- CONTROLES DE ACCIÃ“N -->
            <!-- GestiÃ³n del flujo de grabaciÃ³n -->
            <!-- ================================================= -->
            <VerticalStackLayout Spacing="12">

                <!-- BOTÃ“N: EMPEZAR A ESCUCHAR -->
                <!-- Lanza el reconocimiento de voz -->
                <Button Text="Empezar a Escuchar"
                        Command="{Binding StartListeningCommand}"
                        CornerRadius="25"
                        HeightRequest="50"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold">

                    <!-- Cambios de estado cuando IsListening es true -->
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding IsListening}"
                                     Value="True">

                            <!-- Se desactiva para evitar grabaciones mÃºltiples -->
                            <Setter Property="IsEnabled" Value="False"/>

                            <!-- Feedback visual de estado bloqueado -->
                            <Setter Property="Opacity" Value="0.5"/>

                            <!-- Texto alternativo durante la grabaciÃ³n -->
                            <Setter Property="Text" Value="Grabando..."/>
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <!-- BOTONES SECUNDARIOS -->
                <Grid ColumnDefinitions="*, *"
                      ColumnSpacing="10">

                    <!-- BOTÃ“N: DETENER -->
                    <!-- Solo habilitado mientras se estÃ¡ escuchando -->
                    <Button Grid.Column="0"
                            Text="Detener"
                            Command="{Binding StopListeningCommand}"
                            IsEnabled="{Binding IsListening}"
                            CornerRadius="25"
                            BackgroundColor="{StaticResource Error}"
                            TextColor="{StaticResource TextPrimaryDark}"
                            FontSize="14" />

                    <!-- BOTÃ“N: LISTO -->
                    <!-- Cierra el popup mediante code-behind -->
                    <!-- SoluciÃ³n vÃ¡lida en Popup al no existir cierre directo por Command -->
                    <Button Grid.Column="1"
                            Text="Listo"
                            Clicked="OnCloseClicked"
                            CornerRadius="25"
                            BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#3D3D3D}"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                            FontSize="14" />
                </Grid>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </Border>
</toolkit:Popup>
