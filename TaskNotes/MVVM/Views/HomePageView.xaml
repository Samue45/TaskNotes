<?xml version="1.0" encoding="utf-8" ?>

<!--
    PÃ¡gina principal de la aplicaciÃ³n.
    Muestra la lista de tareas y permite:
    - Filtrar
    - Ordenar
    - Editar
    - Eliminar
    - AÃ±adir tareas (manual o por voz)
-->
<ContentPage
    x:Name="HomePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:TaskNotes.MVVM.ViewModels"
    xmlns:models="clr-namespace:TaskNotes.MVVM.Models"
    xmlns:converters="clr-namespace:TaskNotes.MVVM.Converters"
    x:Class="TaskNotes.MVVM.Views.HomePageView"
    x:DataType="vm:TaskGestorViewModel"
    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}"
    Title="Block de Tareas">

    <!-- ============================= -->
    <!-- RECURSOS LOCALES DE LA PÃGINA -->
    <!-- ============================= -->
    <!-- Converters usados solo en esta vista -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Tacha el texto cuando la tarea estÃ¡ completada -->
            <converters:BoolToStrikethroughConverter
                x:Key="BoolToStrikethroughConverter"/>

            <!-- Devuelve un color segÃºn la prioridad de la tarea -->
            <converters:TaskPriorityToColorConverter
                x:Key="PriorityToColor" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Layout principal:
         - Fila 0: cabecera
         - Fila 1: contenido -->
    <Grid RowDefinitions="Auto, *" Padding="15">

        <!-- ===================== -->
        <!-- CABECERA DE LA PÃGINA -->
        <!-- ===================== -->
        <Grid Grid.Row="0"
              Margin="0,10,0,20"
              ColumnDefinitions="*, Auto">

            <!-- TÃ­tulo de la secciÃ³n -->
            <Label Grid.Column="0"
                   Text="Mis tareas"
                   FontSize="32"
                   FontAttributes="Bold"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource TextPrimaryDark}}" />

            <!-- Acciones rÃ¡pidas: Filtro y Orden -->
            <HorizontalStackLayout Grid.Column="1"
                                   Spacing="10"
                                   VerticalOptions="Center">

                <!-- BotÃ³n para mostrar el ActionSheet de filtros -->
                <Button Text="ðŸŒªï¸"
                        FontSize="20"
                        HeightRequest="45"
                        WidthRequest="45"
                        Padding="0"
                        CornerRadius="12"
                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                        TextColor="{StaticResource Primary}"
                        Clicked="OnFilterClicked">
                    <Button.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Opacity="0.1" Radius="4"/>
                    </Button.Shadow>
                </Button>

                <!-- BotÃ³n para ordenar las tareas por prioridad -->
                <Button Text="âš¡"
                        FontSize="20"
                        HeightRequest="45"
                        WidthRequest="45"
                        Padding="0"
                        CornerRadius="12"
                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                        TextColor="{StaticResource Primary}"
                        Command="{Binding SortByPriorityCommand}">
                    <Button.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Opacity="0.1" Radius="4"/>
                    </Button.Shadow>
                </Button>
            </HorizontalStackLayout>
        </Grid>

        <!-- ======================== -->
        <!-- CONTENIDO PRINCIPAL -->
        <!-- ======================== -->
        <Grid Grid.Row="1">

            <!-- Mensaje visible solo cuando hay un filtro activo -->
            <Label Text="{Binding FilterMessage}"
                   IsVisible="{Binding IsFilterActive}"
                   TextColor="{StaticResource Primary}"
                   FontSize="12"
                   HorizontalOptions="Center"
                   Margin="0,-15,0,5"/>

            <!-- Lista de tareas -->
            <CollectionView ItemsSource="{Binding Tasks}"
                            SelectionMode="None">

                <!-- Layout vertical con separaciÃ³n entre items -->
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                </CollectionView.ItemsLayout>

                <!-- Vista mostrada cuando no hay tareas -->
                <CollectionView.EmptyView>
                    <Grid VerticalOptions="Center" HorizontalOptions="Center">
                        <VerticalStackLayout Spacing="15"
                                             VerticalOptions="Center"
                                             HorizontalOptions="Center">
                            <Label Text="ðŸŒ¿"
                                   FontSize="60"
                                   HorizontalTextAlignment="Center"
                                   Opacity="0.8"/>
                            <Label Text="No hay tareas"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   HorizontalTextAlignment="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                            <Label Text="AÃ±ade una nueva o cambia el filtro."
                                   FontSize="14"
                                   HorizontalTextAlignment="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                        </VerticalStackLayout>
                    </Grid>
                </CollectionView.EmptyView>

                <!-- ================= -->
                <!-- PLANTILLA DE ITEM -->
                <!-- ================= -->
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TaskItem">

                        <!-- Swipe para borrar -->
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItem
                                    Text="Borrar"
                                    BackgroundColor="{StaticResource Error}"
                                    Command="{Binding BindingContext.DeleteTaskCommand, Source={x:Reference HomePage}}"
                                    CommandParameter="{Binding .}" />
                            </SwipeView.RightItems>

                            <!-- Tarjeta visual de la tarea -->
                            <Border Padding="15"
                                    StrokeShape="RoundRectangle 16"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}">

                                <!-- Tap para editar la tarea -->
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Tapped="OnEditTaskTapped"
                                        CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>

                                <!-- Sombra de la tarjeta -->
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="5" Opacity="0.1" />
                                </Border.Shadow>

                                <!-- Estados visuales (hover / normal) -->
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroupList>
                                        <VisualStateGroup x:Name="CommonStates">
                                            <VisualState x:Name="Normal">
                                                <VisualState.Setters>
                                                    <Setter Property="StrokeThickness" Value="0" />
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState x:Name="PointerOver">
                                                <VisualState.Setters>
                                                    <Setter Property="Stroke" Value="{StaticResource Primary}" />
                                                    <Setter Property="StrokeThickness" Value="2" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateGroupList>
                                </VisualStateManager.VisualStateGroups>

                                <!-- Contenido de la tarea -->
                                <Grid ColumnDefinitions="Auto, *, Auto, Auto">

                                    <!-- Checkbox de completado -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsCompleted}"
                                              Color="{StaticResource Primary}"
                                              VerticalOptions="Center"/>

                                    <!-- TÃ­tulo y descripciÃ³n -->
                                    <Grid Grid.Column="1"
                                          RowDefinitions="Auto, Auto"
                                          VerticalOptions="Center"
                                          Margin="10,0">

                                        <!-- TÃ­tulo con tachado si estÃ¡ completada -->
                                        <Grid Grid.Row="0">
                                            <Label Text="{Binding Title}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                                   TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToStrikethroughConverter}}"/>
                                            <BoxView HeightRequest="2.5"
                                                     BackgroundColor="{StaticResource AccentDark}"
                                                     VerticalOptions="Center"
                                                     IsVisible="{Binding IsCompleted}"
                                                     InputTransparent="True"/>
                                        </Grid>

                                        <!-- DescripciÃ³n -->
                                        <Label Grid.Row="1"
                                               Text="{Binding Description}"
                                               FontSize="13"
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                               LineBreakMode="WordWrap"/>
                                    </Grid>

                                    <!-- Prioridad y fecha -->
                                    <VerticalStackLayout Grid.Column="2"
                                                         HorizontalOptions="End"
                                                         VerticalOptions="Center"
                                                         Margin="0,0,10,0">
                                        <Label Text="{Binding Priority}"
                                               FontSize="15"
                                               FontAttributes="Bold"
                                               TextColor="{Binding Priority, Converter={StaticResource PriorityToColor}}"/>
                                        <Label Text="{Binding DueDate, StringFormat='{0:dd MMM}'}"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                    </VerticalStackLayout>

                                    <!-- BotÃ³n eliminar rÃ¡pido -->
                                    <Button Grid.Column="3"
                                            Text="ðŸ—‘ï¸"
                                            BackgroundColor="Transparent"
                                            TextColor="{StaticResource Accent}"
                                            FontSize="20"
                                            Padding="0"
                                            HeightRequest="36"
                                            WidthRequest="36"
                                            VerticalOptions="Center"
                                            Command="{Binding BindingContext.DeleteTaskCommand, Source={x:Reference HomePage}}"
                                            CommandParameter="{Binding .}" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ========================= -->
            <!-- BOTONES FLOTANTES -->
            <!-- ========================= -->
            <HorizontalStackLayout HorizontalOptions="End"
                                   VerticalOptions="End"
                                   Spacing="15"
                                   Margin="0,0,10,20">

                <!-- BotÃ³n de entrada por voz -->
                <Button Text="ðŸŽ™ï¸"
                        FontSize="27"
                        WidthRequest="64"
                        HeightRequest="64"
                        CornerRadius="32"
                        BackgroundColor="{StaticResource PrimaryLight}"
                        Clicked="OnShowAudioPopupClicked">
                    <Button.Shadow>
                        <Shadow Brush="Black" Offset="0,4" Opacity="0.2" Radius="6"/>
                    </Button.Shadow>
                </Button>

                <!-- BotÃ³n para aÃ±adir nueva tarea -->
                <Button Text="+"
                        FontSize="30"
                        WidthRequest="64"
                        HeightRequest="64"
                        CornerRadius="32"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="{StaticResource SurfaceLight}"
                        Clicked="OnAddTaskClicked">
                    <Button.Shadow>
                        <Shadow Brush="{StaticResource PrimaryDark}" Offset="0,5" Opacity="0.4" Radius="8"/>
                    </Button.Shadow>
                </Button>
            </HorizontalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
